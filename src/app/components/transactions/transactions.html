<div class="page-container">
  <div class="transactions-header">
    <h2>Transações</h2>
    <button class="add-btn" (click)="openAddPopup()">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="20"
        height="20"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <line x1="12" y1="5" x2="12" y2="19"></line>
        <line x1="5" y1="12" x2="19" y2="12"></line>
      </svg>
      <span>Adicionar</span>
    </button>
  </div>

  <div class="transactions-container">
    <div *ngIf="allTransactions.length > 0; else noTransactions">
      <div class="transactions-list">
        <div
          *ngFor="let transaction of allTransactions"
          class="transaction-item"
          [ngClass]="transaction.type"
        >
          <div class="transaction-details">
            <span class="transaction-description">{{
              transaction.description
            }}</span>
            <span class="transaction-date">{{
              transaction.date | date : "dd/MM/yyyy"
            }}</span>
          </div>
          <div class="transaction-value">
            {{ transaction.value | currency : "BRL" }}
          </div>
          <div class="transaction-actions">
            <button class="action-btn" (click)="openAddPopup()">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="18"
                height="18"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path
                  d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"
                ></path>
                <path
                  d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"
                ></path>
              </svg>
            </button>
            <button class="action-btn" (click)="openConfirmDelete(transaction)">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="18"
                height="18"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <polyline points="3 6 5 6 21 6"></polyline>
                <path
                  d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"
                ></path>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <ng-template #noTransactions>
    <div class="no-transactions">
      <p>Nenhuma transação encontrada.</p>
      <p>Clique em "Adicionar" para criar sua primeira transação.</p>
    </div>
  </ng-template>
</div>

<div *ngIf="isPopupOpen" class="popup-overlay" (click)="closePopups()">
  <div *ngIf="isPopupOpen" class="popup-overlay" (click)="closePopups()">
    <div class="popup-container" (click)="$event.stopPropagation()">
      <h3>{{ isEditMode ? "Editar" : "Adicionar" }} Transação</h3>

      <form [formGroup]="transactionForm" (ngSubmit)="saveTransaction()">
        <div class="form-group">
          <label for="description">Descrição</label>
          <input
            id="description"
            type="text"
            formControlName="description"
            placeholder="Ex: Salário, Compra de Mouse"
          />
        </div>

        <div class="form-group">
          <label for="value">
            {{
              transactionForm.get("isParcelada")?.value &&
              transactionForm.get("tipoLancamentoParcela")?.value === "parcela"
                ? "Valor de cada Parcela"
                : "Valor"
            }}
          </label>
          <input
            id="value"
            type="text"
            placeholder="R$ 0,00"
            (input)="formatCurrency($event)"
            formControlName="value"
          />
        </div>

        <div class="form-group">
          <label for="date">Data do Primeiro Lançamento</label>
          <input id="date" type="date" formControlName="date" />
        </div>

        <div class="form-group">
          <label for="type">Tipo</label>
          <select id="type" formControlName="type">
            <option value="" disabled>Selecione o tipo...</option>
            <option value="income">Receita</option>
            <option value="expense">Despesa</option>
          </select>
        </div>

        <fieldset [disabled]="isEditMode">
          <div *ngIf="transactionForm.get('type')?.value === 'expense'">
            <div class="form-group checkbox-label">
              <input
                type="checkbox"
                id="isParcelada"
                formControlName="isParcelada"
              />
              <label for="isParcelada">É uma despesa parcelada?</label>
            </div>

            <div
              class="parcela-options"
              *ngIf="transactionForm.get('isParcelada')?.value"
            >
              <div class="form-group radio-group">
                <label class="radio-label">
                  <input
                    type="radio"
                    formControlName="tipoLancamentoParcela"
                    value="total"
                  />
                  <span>Lançar pelo Valor Total</span>
                </label>
                <label class="radio-label">
                  <input
                    type="radio"
                    formControlName="tipoLancamentoParcela"
                    value="parcela"
                  />
                  <span>Lançar pelo Valor da Parcela</span>
                </label>
              </div>

              <div class="form-group">
                <label for="numeroParcelas">Número de Parcelas</label>
                <select id="numeroParcelas" formControlName="numeroParcelas">
                  <option *ngFor="let i of installmentsOptions" [value]="i">
                    {{ i }}x
                  </option>
                </select>
              </div>
            </div>
          </div>

          <div *ngIf="transactionForm.get('type')?.value === 'income'">
            <div class="form-group checkbox-label">
              <input
                type="checkbox"
                id="isRecorrente"
                formControlName="isRecorrente"
              />
              <label for="isRecorrente"
                >É uma receita recorrente (lançar por 12 meses)?</label
              >
            </div>
          </div>
        </fieldset>

        <div class="popup-actions">
          <button type="button" class="btn-secondary" (click)="closePopups()">
            Cancelar
          </button>
          <button
            type="submit"
            class="btn-primary"
            [disabled]="transactionForm.invalid"
          >
            Salvar
          </button>
        </div>
      </form>

      <div
        *ngIf="isConfirmDeleteOpen"
        class="popup-overlay"
        (click)="closePopups()"
      >
        <div
          class="popup-container confirm-dialog"
          (click)="$event.stopPropagation()"
        >
          <h3 class="popup-title-with-icon">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"
              ></path>
              <line x1="12" y1="9" x2="12" y2="13"></line>
              <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
            <span>Confirmar Exclusão</span>
          </h3>
          <p class="popup-message">
            Deseja excluir a transação
            <strong>"{{ transactionToDelete?.description }}"</strong>?
          </p>
          <p class="popup-warning">Esta ação não pode ser desfeita.</p>
          <div class="popup-actions">
            <button type="button" class="btn-secondary" (click)="closePopups()">
              Cancelar
            </button>
            <button
              type="button"
              class="btn-danger"
              (click)="deleteTransaction()"
            >
              Sim, Excluir
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
